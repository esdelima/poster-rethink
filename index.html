<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>MindARThree - Bullets 1-5</title>
  <style>
    html,body { margin:0; height:100%; background:#000; overflow:hidden; }
    #ui { position: fixed; z-index: 50; left:12px; top:12px; display:flex; gap:8px; }
    button { padding:8px 10px; border-radius:8px; border: none; background:#111827; color:#fff; cursor:pointer;}
    #status { color:#fff; align-self:center; margin-left:8px; }
  </style>
  <!-- MindAR + three.js (MindAR bundle already includes three.js) -->
  <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mindar-image.prod.js"></script>
</head>
<body>
  <div id="ui">
    <button id="startBtn">Start AR</button>
    <button id="stopBtn" disabled>Stop AR</button>
    <div id="status">Ready</div>
  </div>

  <div id="container"></div>

  <script>
    // URL targetmu (yang kamu berikan)
    const TARGET_URL = 'https://xppfmghrhhrejnopnyir.supabase.co/storage/v1/object/public/ewan/targets.mind';

    let mindarThree = null;
    let anchors = [];
    let playing = false;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusEl = document.getElementById('status');

    function createNumberCanvas(n) {
      const w = 512, h = 256;
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      const ctx = c.getContext('2d');
      // background white
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,w,h);
      // big number
      ctx.fillStyle = '#000000';
      ctx.font = 'bold 200px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(String(n), w/2, h/2);
      return c;
    }

    async function initMindAR() {
      // ensure MINDAR namespace exists
      if (!window.MINDAR || !window.MINDAR.IMAGE) {
        alert('MindAR library not loaded!');
        throw new Error('MindAR not present');
      }

      // create MindARThree instance
      mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.body,
        imageTargetSrc: TARGET_URL,
        maxTrack: 1,
        // optionally change other params
      });

      const {renderer, scene, camera} = mindarThree;

      // add light
      const light = new THREE.HemisphereLight(0xffffff, 0xbbbbff, 1);
      scene.add(light);

      // create anchor for target index 0
      const anchor = mindarThree.addAnchor(0);
      anchors.push(anchor);

      // Poster aspect: MindAR maps image to width=1 unit by default.
      // We'll create 5 small planes positioned relative to poster center.
      const bulletPositions = [
        [-0.35,  0.45, 0.01],
        [-0.35,  0.15, 0.01],
        [-0.35, -0.15, 0.01],
        [ 0.25,  0.20, 0.01],
        [ 0.25, -0.20, 0.01],
      ];

      bulletPositions.forEach((pos, i) => {
        const canvas = createNumberCanvas(i+1);
        const tex = new THREE.CanvasTexture(canvas);
        tex.needsUpdate = true;

        // plane geometry roughly width 0.18 x height 0.12 (same as A-Frame example)
        const geom = new THREE.PlaneGeometry(0.18, 0.12);
        const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: false });
        const mesh = new THREE.Mesh(geom, mat);
        mesh.position.set(pos[0], pos[1], pos[2]);
        mesh.visible = false; // hide initially
        anchor.group.add(mesh);

        // add click interaction using raycaster later
        mesh.userData.bulletIndex = i;
      });

      // events: when target found/lost, show/hide bullets
      anchor.onTargetFound = () => {
        statusEl.innerText = 'Target found';
        // show first bullet by default
        anchor.group.children.forEach((m, i) => {
          m.visible = (i === 0);
        });
      };
      anchor.onTargetLost = () => {
        statusEl.innerText = 'Target lost';
        anchor.group.children.forEach(m => m.visible = false);
      };

      // start rendering loop
      await mindarThree.start();
      renderer.setSize(window.innerWidth, window.innerHeight);
      statusEl.innerText = 'AR started — point camera to poster';
      stopBtn.disabled = false;
      startBtn.disabled = true;

      // animation loop: mindarThree provides update via renderer.setAnimationLoop
      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });

      // Add simple tap/click to cycle bullets (works on mobile: listen for touch)
      window.addEventListener('click', (ev) => {
        // do a raycast from screen center (or use touch coords)
        // we'll just cycle bullets on click
        const group = anchor.group;
        if (!group) return;
        const nextVisibleIndex = (group.children.findIndex(c=>c.visible) + 1) % group.children.length;
        group.children.forEach((m,i)=> m.visible = (i===nextVisibleIndex));
      });
    }

    startBtn.addEventListener('click', async () => {
      statusEl.innerText = 'Starting AR...';
      try {
        // test fetch targets.mind first to get clearer error
        await fetch(TARGET_URL).then(r => {
          if (!r.ok) throw new Error('targets.mind fetch failed: ' + r.status);
        });

        await initMindAR();
      } catch (err) {
        console.error(err);
        alert('Gagal start AR: ' + (err && err.message ? err.message : err));
        statusEl.innerText = 'Start failed — lihat console';
      }
    });

    stopBtn.addEventListener('click', async () => {
      statusEl.innerText = 'Stopping AR...';
      if (mindarThree) {
        try {
          await mindarThree.stop();
          mindarThree.renderer.setAnimationLoop(null);
        } catch(e) { console.warn(e); }
        mindarThree = null;
      }
      stopBtn.disabled = true;
      startBtn.disabled = false;
      statusEl.innerText = 'Stopped';
    });

    // Helpful console hint:
    console.log('Ready. If A-Frame approach fails, this MindARThree fallback should work.');
  </script>

  <!-- Note: MindAR build includes THREE.js internally, so we don't need to include three separately. -->
</body>
</html>
