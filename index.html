<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Web AR — Poster Bullets (Markerless) — Fokus Bullet</title>
  <style>
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial}
    #app{position:fixed;inset:0;display:flex;flex-direction:column}
    #camera{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)}
    #overlay{position:absolute;inset:0;pointer-events:none}
    #hud{position:fixed;left:12px;top:12px;background:rgba(0,0,0,0.5);color:#fff;padding:8px 10px;border-radius:8px;z-index:40;font-size:14px}
    .frame{position:absolute;border:2px dashed rgba(255,255,255,0.95);box-shadow:0 6px 20px rgba(0,0,0,0.4);border-radius:8px;pointer-events:auto}
    .bullet{position:absolute;width:40px;height:40px;border-radius:50%;background:rgba(0,0,0,0.7);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700;cursor:pointer;box-shadow:0 3px 8px rgba(0,0,0,0.5);}
    #controls{position:fixed;right:12px;top:12px;z-index:50;display:flex;gap:8px;flex-direction:column}
    .btn{background:rgba(255,255,255,0.9);border-radius:8px;padding:8px 10px;font-weight:600;border:0;cursor:pointer}
    #hint{position:fixed;left:12px;bottom:12px;background:rgba(0,0,0,0.5);color:#fff;padding:8px;border-radius:8px;z-index:40;font-size:13px}
    #toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,0.75);color:#fff;padding:8px 12px;border-radius:8px;z-index:80;display:none}
  </style>
</head>
<body>
<div id="app">
  <video id="camera" autoplay playsinline muted></video>
  <div id="overlay"></div>

  <div id="hud">Ketuk layar untuk menempatkan bingkai 4:5. Setelah bingkai muncul, ketuk di dalam bingkai untuk menambahkan bullet (nomor).</div>

  <div id="controls">
    <button id="fsBtn" class="btn">Fullscreen</button>
    <button id="clearBtn" class="btn">Hapus Semua</button>
    <button id="saveBtn" class="btn">Simpan</button>
    <button id="loadBtn" class="btn">Muat</button>
  </div>

  <div id="hint">Bingkai belum ditempatkan</div>
  <div id="toast"></div>
</div>

<script>
(async function(){
  const video = document.getElementById('camera');
  const overlay = document.getElementById('overlay');
  const hud = document.getElementById('hud');
  const hint = document.getElementById('hint');
  const toast = document.getElementById('toast');
  const fsBtn = document.getElementById('fsBtn');
  const clearBtn = document.getElementById('clearBtn');
  const saveBtn = document.getElementById('saveBtn');
  const loadBtn = document.getElementById('loadBtn');

  // camera
  try{
    const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:'environment'}}, audio:false});
    video.srcObject = stream;
  }catch(e){
    try{ const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false}); video.srcObject = s; }
    catch(err){ console.error('camera error', err); alert('Tidak dapat mengakses kamera. Pastikan izin diberikan.'); }
  }

  // model
  let frameEl = null;
  let bullets = []; // {id,relX,relY,number}
  let nextNum = 1;

  function showToast(msg,ms=1100){ toast.textContent=msg; toast.style.display='block'; setTimeout(()=>{ toast.style.display='none'; }, ms); }

  // save/load
  function saveData(){
    const data = {frame: frameEl ? {left: frameEl.style.left, top: frameEl.style.top, width: frameEl.style.width, height: frameEl.style.height} : null, bullets};
    localStorage.setItem('ar_bullets_v1', JSON.stringify(data)); showToast('Tersimpan');
  }
  function loadData(){
    const raw = localStorage.getItem('ar_bullets_v1'); if(!raw){ showToast('Tidak ada data'); return; }
    const data = JSON.parse(raw);
    clearAll(false);
    if(data.frame) createFrameFromData(data.frame);
    if(data.bullets) data.bullets.forEach(b=>createBulletFromData(b));
    showToast('Dimuat');
  }
  function clearAll(ask=true){
    bullets = []; nextNum = 1;
    if(frameEl){ frameEl.remove(); frameEl=null; }
    Array.from(overlay.querySelectorAll('.bullet')).forEach(b=>b.remove());
    hint.textContent='Bingkai belum ditempatkan';
  }

  clearBtn.addEventListener('click', ()=>clearAll());
  saveBtn.addEventListener('click', saveData);
  loadBtn.addEventListener('click', loadData);

  // place frame once via tap
  overlay.addEventListener('click', (ev)=>{
    if(frameEl) return;
    const rect = overlay.getBoundingClientRect();
    const x = ev.clientX - rect.left; const y = ev.clientY - rect.top;
    const width = Math.min(rect.width*0.75, 700);
    const height = width * 5/4; // 4:5 ratio -> height = width*(5/4)
    const left = x - width/2; const top = y - height/2;
    frameEl = document.createElement('div'); frameEl.className='frame';
    frameEl.style.left = Math.max(8, left) + 'px'; frameEl.style.top = Math.max(8, top) + 'px'; frameEl.style.width = width + 'px'; frameEl.style.height = height + 'px';
    overlay.appendChild(frameEl);
    frameMakeDraggable(frameEl);
    hint.textContent='Bingkai ditempatkan — ketuk di dalam bingkai untuk menambah bullet';
    hud.style.display='none';
    ev.stopPropagation();
  });

  // create bullet immediately when tapping inside frame (no info input for now)
  overlay.addEventListener('pointerdown', (ev)=>{
    if(!frameEl) return;
    const isInside = ev.target === frameEl || frameEl.contains(ev.target);
    if(!isInside) return;
    // avoid creating bullet when clicking on existing bullets
    if(ev.target.classList && ev.target.classList.contains('bullet')) return;
    const fRect = frameEl.getBoundingClientRect();
    const relX = (ev.clientX - fRect.left) / fRect.width;
    const relY = (ev.clientY - fRect.top) / fRect.height;
    const b = {id:Date.now(), relX, relY, number: nextNum}; bullets.push(b);
    createBulletFromData(b);
    nextNum++;
    showToast('Bullet #' + (nextNum-1));
    ev.stopPropagation(); ev.preventDefault();
  });

  function createBulletFromData(b){
    if(!frameEl) return; const el = document.createElement('div'); el.className='bullet'; el.dataset.id=b.id; el.textContent = b.number; positionBulletEl(el,b.relX,b.relY); frameEl.appendChild(el);
    // clicking a bullet currently does nothing (reserved for later).
    el.addEventListener('click',(ev)=>{ ev.stopPropagation(); showToast('Klik akan menampilkan detail nanti'); });
  }

  function positionBulletEl(el, relX, relY){ const w = frameEl.clientWidth; const h = frameEl.clientHeight; const size = 40; const left = relX * w - size/2; const top = relY * h - size/2; el.style.left = left + 'px'; el.style.top = top + 'px'; }

  function frameMakeDraggable(el){
    let dragging=false, startX, startY, startLeft, startTop;
    el.addEventListener('pointerdown',(ev)=>{ if(ev.target.classList && ev.target.classList.contains('bullet')) return; dragging=true; startX=ev.clientX; startY=ev.clientY; startLeft=parseFloat(el.style.left); startTop=parseFloat(el.style.top); el.setPointerCapture && el.setPointerCapture(ev.pointerId); });
    window.addEventListener('pointermove',(ev)=>{ if(!dragging) return; const dx=ev.clientX-startX; const dy=ev.clientY-startY; el.style.left=(startLeft+dx)+'px'; el.style.top=(startTop+dy)+'px'; });
    window.addEventListener('pointerup',(ev)=>{ if(dragging){ dragging=false; try{ ev.target.releasePointerCapture && ev.target.releasePointerCapture(ev.pointerId);}catch(e){} }});

    // resize handle
    const handle = document.createElement('div'); handle.style.position='absolute'; handle.style.right='6px'; handle.style.bottom='6px'; handle.style.width='18px'; handle.style.height='18px'; handle.style.borderRadius='4px'; handle.style.background='rgba(255,255,255,0.8)'; handle.style.touchAction='none'; handle.style.cursor='nwse-resize'; el.appendChild(handle);
    let resizing=false, startCX, startCY, startW;
    handle.addEventListener('pointerdown',(ev)=>{ resizing=true; startCX=ev.clientX; startCY=ev.clientY; startW=el.clientWidth; handle.setPointerCapture && handle.setPointerCapture(ev.pointerId); ev.stopPropagation(); });
    window.addEventListener('pointermove',(ev)=>{ if(!resizing) return; const dx=ev.clientX-startCX; let newW = Math.max(120, startW + dx); let newH = newW * 5/4; el.style.width=newW+'px'; el.style.height=newH+'px'; [...el.querySelectorAll('.bullet')].forEach(bEl=>{ const id=bEl.dataset.id; const data = bullets.find(x=>String(x.id)===String(id)); if(data) positionBulletEl(bEl,data.relX,data.relY); }); });
    window.addEventListener('pointerup',(ev)=>{ if(resizing){ resizing=false; try{ ev.target.releasePointerCapture && ev.target.releasePointerCapture(ev.pointerId);}catch(e){} }});
  }

  // fullscreen
  fsBtn.addEventListener('click', async ()=>{ try{ await document.documentElement.requestFullscreen(); }catch(e){console.warn(e)} });

})();
</script>
</body>
</html>
